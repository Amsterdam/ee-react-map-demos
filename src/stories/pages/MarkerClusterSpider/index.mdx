import { Canvas, Meta, Source, Story } from '@storybook/blocks';
import * as MarkerClusterSpiderStories from './index.stories';
import MarkerClusterSpider from '@/pages/MarkerClusterSpider/MarkerClusterSpider?raw';
import getMapData from '@/pages/MarkerClusterSpider/getMapData?raw';
import processFeatures from '@/pages/MarkerClusterSpider/processFeatures?raw';
import styles from '@/pages/MarkerClusterSpider/styles.module.css?raw';
import types from '@/pages/MarkerClusterSpider/types?raw';
import data from '@/pages/MarkerClusterSpider/data.json?raw';
import mapStyles from '@/pages/MarkerClusterSpider/mapStyles?raw';
import roundNumber from '@/pages/MarkerClusterSpider/utils/roundNumber?raw';
import createClusterShapes from '@/pages/MarkerClusterSpider/utils/createClusterShapes?raw';
import toGeoJSON from '@/utils/toGeoJSON?raw';
import toBoundsLiteral from '@/utils/toBoundsLiteral?raw';

<Meta of={MarkerClusterSpiderStories} />

# Marker clustering (spiderfy)

**[GitHub Repo URL](https://github.com/Amsterdam/ee-react-map-demos/tree/main/src/pages/MarkerCluster)**

## Requirements

- This example is built upon the [BaseMap component example](../?path=/docs/react-baselayer--docs).
- [See global requirements list](../?path=/docs/global-requirements--docs)
- [Supercluster](https://www.npmjs.com/package/supercluster)

**For typescript:**

- [@types/geojson](https://www.npmjs.com/package/@types/geojson)
- [@types/supercluster](https://www.npmjs.com/package/@types/supercluster)

## Description

This is a simple implementation of the [Mapbox](https://www.mapbox.com/) [Supercluster library](https://github.com/mapbox/supercluster) in a React component. The static data for this example has intentionally been duplicated at two locations: **Dijksgracht 19** and **Papaverweg 33**.

Please note if you are working with data that has no records with the same geometry values, there is a [simpler version](../?path=/story/react-markercluster--default) of this component available.

### Data handling

In the `useMemo` call (lines 112-125) we process the data in two methods.

1. The primary call (`getMapData`) could exist in an API/backend-for-frontend application. This method effectively returns data with features inside the current map's bounding box and creates a supercluster object, with an added `expansion_zoom` data property, which is used later in cluster event listeners.

2. The secondary method (`processFeatures`) separates the markers and cluster items. For markers with the same geometry values, it also generates the GeoJSON for the re-generated cluster markers (new markers surrounding the initial marker positioning).

### Display options

There are three options for how to display the cluster:
- `clusterShape` = `circle` or `spiral`

    *Circle draws the markers around the original marker geometry. Spiral draws the markers in spiral curve around the original marker geometry.*

- spiderfyOnMaxZoom: `true` or `false`

    *This draws straight lines from the new clustered marker to the original geometry point. It works best with `clusterShape=circle`*

TODO alternative lib - leaflet.markercluster
TODO MarkerClusterSpider -> MarkerClusterSpiderfy?

### Alternative library

There is also the [Leaflet.markercluster library](https://github.com/Leaflet/Leaflet.markercluster), which has been used in previous Gemeente Amsterdam projects. This [blog post](https://blog.mapbox.com/clustering-millions-of-points-on-a-map-with-supercluster-272046ec5c97) explains the improved performance from [Supercluster](https://github.com/mapbox/supercluster).

## Background

Marker clustering is a technique used in map development to manage and display a large number of markers efficiently. When there are many markers in close proximity to each other, showing all of them individually can clutter the map, making it difficult to navigate and interpret. Marker clustering combines nearby markers into a single cluster marker, which then splits into individual markers as the map is zoomed in.

### Key Benefits of Marker Clustering

- **Improved Performance**: Reduces the number of markers rendered on the map, leading to faster load times and smoother interactions.
- **Enhanced Usability**: Prevents the map from becoming cluttered and overwhelming for the user.
Makes it easier for users to identify areas with high concentrations of markers.
- **Clearer Visualization**: Provides a more organized and readable map, allowing users to better understand the data distribution.

### When to Use Marker Clustering

- **High Density of Markers**: When you have a large number of markers that are densely packed in certain areas.
- **Performance Optimization**: If the map's performance is lagging due to the high number of markers being displayed.
- **User Experience**: When you want to improve the user experience by avoiding clutter and making the map more navigable.

### Usage Scenarios

- **Address Listings**: Displaying properties in a city where there are many in certain neighborhoods.
- **Event Locations**: Showing locations of events or points of interest in a metropolitan area.
- **Geotagged Social Media Posts**: Visualizing posts or photos tagged with location data in a popular tourist destination.

## How to implement

To implement marker clustering with Leaflet, there are X files:

1. The React component
    * [MarkerClusterSpider.tsx](#1-markerclusterspidertsx)
        * *This is based on the [BaseMap component example](../?path=/docs/react-baselayer--docs) so includes a dependency on [`utils/getCrsRd`](../?path=/docs/react-baselayer--docs#1-getcrsrdts).*
2. Data handling
    1. [getMapData.ts](#1-getmapdatats)
    2. [processFeatures.ts](#2-processfeaturests)
3. The CSS styles
    * [styles.module.css](#1-stylesmodulecss)
4. Types for data (typescript only)
    * [types.ts](#1-typests) *(These have been kept minimal and are primarily for examples.)*
5. Data
    * [data.json](#1-datajson) *(This static data should be replaced by a fetch call or other static data)*
6. Map and cluster options and styles
    * [mapStyles.ts](#1-mapstylests)
7. Utils
    1. Round number util
        * [utils/roundNumber.ts](#1-utilsroundnumberts)
    2. createClusterShapes
        * [utils/createClusterShapes.ts](#2-utilscreateclustershapes)
    3. toGeoJSON.ts
        * [utils/toGeoJSON.ts](#3-utilstogeojsonts)
    4. toBoundsLiteral.ts
        * [utils/toBoundsLiteral.ts](#4-utilstoboundsliteralts)

## Usage

### 1. The React component

#### 1. MarkerClusterSpider.tsx

<Source code={MarkerClusterSpider} />

### 2. Data handling

#### 1. getMapData.ts

<Source code={getMapData} />

#### 2. processFeatures.ts

<Source code={processFeatures} />

### 3. CSS Styles

#### 1. styles.module.css

<Source code={styles} />

### 4. Types for data

#### 1. types.ts

<Source code={types} />

### 5. Data

#### 1. data.json

*Code intentionally shortened*

<Source code={`${data.substring(0, 800)}...`} />

### 6. Map Styles

#### 1. mapStyles.ts

<Source code={mapStyles} />

### 7. Utils

#### 1. utils/roundNumber.ts

<Source code={roundNumber} />

#### 2. utils/createClusterShapes.ts

<Source code={createClusterShapes} />

#### 3. utils/toGeoJSON.ts

<Source code={toGeoJSON} />

#### 4. utils/toBoundsLiteral.ts

<Source code={toBoundsLiteral} />
